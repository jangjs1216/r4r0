version: '3.8'

services:
  # --- Frontend (React + Nginx) ---
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - auth-service
    networks:
      - r4r0-net

  # --- Backend Services ---

  # AuthService (Key Manager)
  auth-service:
    build:
      context: .
      dockerfile: services/auth/Dockerfile
    volumes:
      - ./data:/app/data # Persist SQLite DB
    environment:
      - MASTER_KEY=${MASTER_KEY:-dev_master_key_do_not_use_in_prod}
      - DB_FILE_PATH=/app/data/auth.db
    networks:
      - r4r0-net

  # ExchangeAdapter (Connectivity)
  exchange-adapter:
    build:
      context: .
      dockerfile: services/exchange_adapter/Dockerfile
    environment:
      - AUTH_SERVICE_URL=http://auth-service:8000
    depends_on:
      - auth-service
    networks:
      - r4r0-net

  # BotService (Bot Configuration & Lifecycle)
  bot-service:
    build:
      context: ./services/bot_service
      dockerfile: Dockerfile
    volumes:
      - ./data:/app/data
    ports:
      - "8001:8000" # Expose for testing
    environment:
      - DATABASE_URL=sqlite:////app/data/bots.db
    networks:
      - r4r0-net

  # TradingStrategyViewService (Metadata)
  trading-strategy-view:
    build:
      context: ./services/trading_strategy_view
      dockerfile: Dockerfile
    ports:
      - "8002:8000" # Expose for testing
    networks:
      - r4r0-net

  # ExecutionService (Worker Engine)
  execution-service:
    build:
      context: ./services/execution_service
      dockerfile: Dockerfile
    container_name: r4r0-execution-service
    environment:
      - BOT_SERVICE_URL=http://bot-service:8000
      - ADAPTER_SERVICE_URL=http://exchange-adapter:8001
    depends_on:
      - bot-service
      - exchange-adapter
    networks:
      - r4r0-net

  # BacktestService (Historical Simulation)
  backtest-service:
    build:
      context: ./services/backtest_service
      dockerfile: Dockerfile
    ports:
      - "8003:8000"
    networks:
      - r4r0-net

networks:
  r4r0-net:
    driver: bridge
